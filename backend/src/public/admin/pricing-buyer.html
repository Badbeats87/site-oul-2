<!doctype html>
<html lang="en" style="height: auto; overflow: auto;">
  <head>
    <style>
      html { height: auto !important; overflow: auto !important; }
      body { min-height: 100vh !important; overflow-y: auto !important; }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buyer Pricing Policy - Vinyl Catalog Admin</title>
    <link rel="stylesheet" href="../../styles/design-system.css" />
    <link rel="stylesheet" href="../../styles/admin.css" />
    <link rel="stylesheet" href="../../styles/pricing-editor.css" />
  </head>
  <body style="min-height: 100vh; overflow-y: auto;">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar__container">
        <a href="index.html" class="navbar__logo">
          <svg
            class="navbar__icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          <span>Vinyl Catalog</span>
        </a>
        <!-- Hamburger Menu Toggle -->
        <button
          class="navbar__menu-toggle"
          data-menu-toggle
          aria-label="Toggle navigation menu"
          aria-expanded="false"
          title="Toggle menu"
        >
          <span></span>
          <span></span>
          <span></span>
        </button>

        <div class="navbar__links" data-navbar-links>
          <a href="index.html" class="nav-link">‚Üê Back to Admin</a>
          <a href="pricing-seller.html" class="nav-link">Seller Pricing</a>
        </div>
      </div>
    </nav>

    <!-- Header -->
    <header class="page-header">
      <div class="container">
        <h1>Buyer Pricing Policy</h1>
        <p>Configure offer prices and buyer purchasing formulas</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="page-content">
      <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="Breadcrumb">
          <ol class="breadcrumb-list">
            <li class="breadcrumb-item">
              <a href="../index.html">Vinyl Catalog</a>
            </li>
            <li class="breadcrumb-item">
              <a href="index.html">Admin Console</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Buyer Pricing
            </li>
          </ol>
        </nav>

        <!-- Policy Info Section -->
        <section class="policy-section">
          <h2 class="section-title">Policy Information</h2>

          <div class="form-row">
            <div class="form-group">
              <label>Policy Name</label>
              <input
                type="text"
                value="Standard Global"
                placeholder="e.g., Classic Rock Premium"
              />
            </div>
            <div class="form-group">
              <label>Description</label>
              <input
                type="text"
                placeholder="Optional notes about this policy"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Scope</label>
              <select>
                <option selected>All Releases (Global)</option>
                <option>By Genre</option>
                <option>By Label</option>
                <option>By Acquisition Channel</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select>
                <option selected>Active</option>
                <option>Draft</option>
                <option>Archived</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Condition Curves -->
        <section class="policy-section">
          <h2 class="section-title">Condition Grade Adjustments</h2>
          <p class="section-subtitle">
            Define percentage adjustments for each condition grade. These are
            applied multiplicatively to base prices.
          </p>

          <!-- Media Condition Curve -->
          <div class="condition-table-wrapper">
            <h3 class="subsection-title">Media Condition Curve</h3>
            <table class="table condition-table">
              <thead>
                <tr>
                  <th>Grade</th>
                  <th>Description</th>
                  <th style="width: 120px">Adjustment %</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Mint (M)</strong></td>
                  <td>Perfect, unplayed condition</td>
                  <td>
                    <input type="number" value="115" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Near Mint (NM)</strong></td>
                  <td>Minimal signs of wear</td>
                  <td>
                    <input type="number" value="100" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good Plus (VG+)</strong></td>
                  <td>Light wear, plays perfectly</td>
                  <td>
                    <input type="number" value="80" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good (VG)</strong></td>
                  <td>Moderate wear visible</td>
                  <td>
                    <input type="number" value="65" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good Minus (VG-)</strong></td>
                  <td>Significant wear but playable</td>
                  <td>
                    <input type="number" value="50" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Good (G)</strong></td>
                  <td>Heavy wear, may affect playback</td>
                  <td>
                    <input type="number" value="30" class="input-percentage" />
                    %
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Sleeve Condition Curve -->
          <div class="condition-table-wrapper">
            <h3 class="subsection-title">Sleeve Condition Curve</h3>
            <table class="table condition-table">
              <thead>
                <tr>
                  <th>Grade</th>
                  <th>Description</th>
                  <th style="width: 120px">Adjustment %</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Mint (M)</strong></td>
                  <td>Perfect, no creases or wear</td>
                  <td>
                    <input type="number" value="105" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Near Mint (NM)</strong></td>
                  <td>Minimal storage wear only</td>
                  <td>
                    <input type="number" value="100" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good Plus (VG+)</strong></td>
                  <td>Minor creases or edge wear</td>
                  <td>
                    <input type="number" value="78" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good (VG)</strong></td>
                  <td>Obvious creases, fading</td>
                  <td>
                    <input type="number" value="55" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Very Good Minus (VG-)</strong></td>
                  <td>Heavy creasing, stains</td>
                  <td>
                    <input type="number" value="40" class="input-percentage" />
                    %
                  </td>
                </tr>
                <tr>
                  <td><strong>Good (G)</strong></td>
                  <td>Severe damage, writing, water</td>
                  <td>
                    <input type="number" value="20" class="input-percentage" />
                    %
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Condition Weighting -->
          <div class="form-row">
            <div class="form-group">
              <label>Media Weight</label>
              <p class="input-help">How much media condition affects buyer offers</p>
              <div class="input-with-unit">
                <input type="number" value="70" min="0" max="100" />
                <span class="unit">%</span>
              </div>
            </div>
            <div class="form-group">
              <label>Sleeve Weight</label>
              <p class="input-help">
                How much sleeve condition affects buyer offers
              </p>
              <div class="input-with-unit">
                <input type="number" value="30" min="0" max="100" />
                <span class="unit">%</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Buy Formula -->
        <section class="policy-section">
          <h2 class="section-title">Offer Formula</h2>
          <p class="section-subtitle">
            Offer = Market Stat √ó Buy % √ó Condition Adjustment
          </p>

          <div class="formula-box">
            <div class="formula-step">
              <span class="formula-label">Market Data Source:</span>
              <select style="max-width: 400px">
                <option selected>Hybrid (Average Discogs & eBay)</option>
                <option>Discogs (Primary) ‚Üí eBay (Fallback)</option>
                <option>eBay (Primary) ‚Üí Discogs (Fallback)</option>
                <option>Discogs Only</option>
                <option>eBay Only</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price Statistic</label>
              <select>
                <option>Low (Lowest sale)</option>
                <option selected>Median (Middle sale)</option>
                <option>High (Highest sale)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Buy Percentage</label>
              <div class="input-with-unit">
                <input type="number" value="55" min="0" max="100" />
                <span class="unit">%</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Data Lookback Window</label>
              <select>
                <option>30 days</option>
                <option selected>90 days</option>
                <option>180 days</option>
                <option>1 year</option>
              </select>
            </div>
            <div class="form-group">
              <label>Round to Nearest</label>
              <select>
                <option>$0.01</option>
                <option selected>$0.25</option>
                <option>$0.50</option>
                <option>$1.00</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Minimum Offer (Floor)</label>
              <input type="number" value="5.00" step="0.25" placeholder="$" />
            </div>
            <div class="form-group">
              <label>Maximum Offer (Cap)</label>
              <input type="number" value="500.00" step="0.25" placeholder="$" />
            </div>
          </div>

          <div class="form-group">
            <label>Offer Valid For</label>
            <div class="input-with-unit">
              <input type="number" value="14" min="1" />
              <span class="unit">days</span>
            </div>
          </div>
        </section>

        <!-- Channel Multipliers -->
        <section class="policy-section">
          <h2 class="section-title">Channel-Specific Adjustments</h2>
          <p class="section-subtitle">
            Apply multipliers to different acquisition channels
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Channel</th>
                <th style="width: 120px">Buy Multiplier</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Web Submission</strong></td>
                <td>
                  <input
                    type="number"
                    value="1.0"
                    step="0.05"
                    class="input-small"
                  />
                </td>
                <td>Standard rates</td>
              </tr>
              <tr>
                <td><strong>Store Walk-In</strong></td>
                <td>
                  <input
                    type="number"
                    value="0.95"
                    step="0.05"
                    class="input-small"
                  />
                </td>
                <td>Lower buy offer (no shipping)</td>
              </tr>
              <tr>
                <td><strong>Bulk Collection</strong></td>
                <td>
                  <input
                    type="number"
                    value="0.85"
                    step="0.05"
                    class="input-small"
                  />
                </td>
                <td>Discount for large lots</td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- Preview -->
        <section class="policy-section">
          <h2 class="section-title">Preview: Example Offer Calculations</h2>
          <p class="section-subtitle">
            How this policy would calculate offers for a sample album
          </p>

          <div class="preview-album">
            <strong>Sample: Dark Side of the Moon by Pink Floyd</strong><br />
            <span class="text-muted"
              >Market Data: Discogs Median $85 | eBay Median $92 | Hybrid Average $88.50</span
            >
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Media / Sleeve</th>
                <th>Offer Price</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background: rgba(16, 185, 129, 0.05)">
                <td>
                  <strong>Mint / Mint</strong><br /><span class="text-muted"
                    >120% √ó 110%</span
                  >
                </td>
                <td><strong>$58.24</strong></td>
              </tr>
              <tr>
                <td>
                  <strong>Near Mint / Near Mint</strong><br /><span
                    class="text-muted"
                    >100% √ó 100%</span
                  >
                </td>
                <td><strong>$48.68</strong></td>
              </tr>
              <tr>
                <td>
                  <strong>Very Good / Very Good+</strong><br /><span
                    class="text-muted"
                    >60% √ó 75%</span
                  >
                </td>
                <td><strong>$21.91</strong></td>
              </tr>
              <tr>
                <td>
                  <strong>Good / Good</strong><br /><span class="text-muted"
                    >25% √ó 15%</span
                  >
                </td>
                <td><strong>$5.86</strong></td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- Actions -->
        <div class="policy-actions">
          <button class="button button--success button--lg">
            ‚úì Save Policy
          </button>
          <button class="button button--primary button--lg">
            üìã Preview in Queue
          </button>
          <button class="button button--secondary button--lg">
            Reset to Default
          </button>
          <a href="index.html" class="button button--secondary button--lg"
            >‚Üê Cancel</a
          >
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer__content">
          <div class="footer__section">
            <h4>Vinyl Catalog</h4>
            <p>Admin console for catalog management</p>
          </div>
        </div>
        <div class="footer__bottom">
          <p>&copy; 2024 Vinyl Catalog. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script src="../../js/mobile-nav.js"></script>
    <script src="../../js/active-states.js"></script>

    <script>
      /**
       * Buyer Pricing Policy Manager
       * Handles loading and saving pricing policies
       */
      const buyerPricingManager = {
        policyType: 'BUYER',
        authToken: null,

        init() {
          this.cacheAuthToken();
          this.bindEvents();
          this.loadPolicy();
        },

        cacheAuthToken() {
          this.authToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        },

        bindEvents() {
          // Save Policy button
          document.querySelector('.button--success')?.addEventListener('click', () => this.savePolicy());

          // Reset to Default button
          document.querySelector('.button--secondary:nth-of-type(3)')?.addEventListener('click', () => this.resetToDefault());
        },

        async loadPolicy() {
          try {
            if (!this.authToken) {
              console.log('Not authenticated, showing default values');
              return;
            }

            const response = await fetch(`/api/v1/admin/pricing/${this.policyType}`, {
              headers: {
                'Authorization': `Bearer ${this.authToken}`,
              },
            });

            if (!response.ok) {
              console.warn('Failed to load policy:', response.status);
              return;
            }

            const data = await response.json();
            if (data.data) {
              this.populateForm(data.data);
            }
          } catch (error) {
            console.error('Error loading policy:', error);
          }
        },

        populateForm(policy) {
          // Policy name
          document.querySelector('input[placeholder="e.g., Classic Rock Premium"]').value = policy.name || 'Standard Global';

          // Media condition curve
          const mediaInputs = document.querySelectorAll('.condition-table:nth-of-type(1) .input-percentage');
          const mediaConditions = ['MINT', 'NM', 'VG_PLUS', 'VG', 'VG_MINUS', 'G'];
          mediaInputs.forEach((input, idx) => {
            const condition = mediaConditions[idx];
            if (policy.conditionCurve?.[condition]) {
              input.value = policy.conditionCurve[condition] * 100;
            }
          });

          // Sleeve condition curve
          const sleeveInputs = document.querySelectorAll('.condition-table:nth-of-type(2) .input-percentage');
          sleeveInputs.forEach((input, idx) => {
            const condition = mediaConditions[idx];
            if (policy.conditionCurve?.[`SLEEVE_${condition}`]) {
              input.value = policy.conditionCurve[`SLEEVE_${condition}`] * 100;
            }
          });

          // Weights
          document.querySelectorAll('.input-with-unit input')[0].value = policy.buyFormula?.mediaWeight * 100 || 70;
          document.querySelectorAll('.input-with-unit input')[1].value = policy.buyFormula?.sleeveWeight * 100 || 30;

          // Buy percentage
          document.querySelectorAll('.form-group input[type="number"]')[4].value = policy.buyFormula?.buyPercentage * 100 || 55;

          // Min/Max offers
          document.querySelectorAll('.form-group input[type="number"]')[5].value = policy.minOffer || 5.00;
          document.querySelectorAll('.form-group input[type="number"]')[6].value = policy.maxOffer || 500.00;

          // Offer valid for
          document.querySelectorAll('.form-group input[type="number"]')[7].value = policy.offerExpiryDays || 14;

          // Channel multipliers
          const channelInputs = document.querySelectorAll('.table:last-of-type .input-small');
          const multipliers = policy.buyFormula?.channelMultipliers || { WEB: 1.0, WALK_IN: 0.95, BULK: 0.85 };
          channelInputs[0].value = multipliers.WEB || 1.0;
          channelInputs[1].value = multipliers.WALK_IN || 0.95;
          channelInputs[2].value = multipliers.BULK || 0.85;
        },

        async savePolicy() {
          try {
            if (!this.authToken) {
              alert('Not authenticated. Please log in first.');
              return;
            }

            // Collect form data
            const policyName = document.querySelector('input[placeholder="e.g., Classic Rock Premium"]').value;

            // Media condition curve
            const mediaConditions = ['MINT', 'NM', 'VG_PLUS', 'VG', 'VG_MINUS', 'G'];
            const mediaInputs = document.querySelectorAll('.condition-table:nth-of-type(1) .input-percentage');
            const mediaConditionCurve = {};
            mediaInputs.forEach((input, idx) => {
              mediaConditionCurve[mediaConditions[idx]] = parseFloat(input.value) / 100;
            });

            // Sleeve condition curve
            const sleeveInputs = document.querySelectorAll('.condition-table:nth-of-type(2) .input-percentage');
            const sleeveConditionCurve = {};
            sleeveInputs.forEach((input, idx) => {
              sleeveConditionCurve[`SLEEVE_${mediaConditions[idx]}`] = parseFloat(input.value) / 100;
            });

            const conditionCurve = { ...mediaConditionCurve, ...sleeveConditionCurve };

            // Buy formula
            const buyPercentage = parseFloat(document.querySelectorAll('.form-group input[type="number"]')[4].value) / 100;
            const mediaWeight = parseFloat(document.querySelectorAll('.input-with-unit input')[0].value) / 100;
            const sleeveWeight = parseFloat(document.querySelectorAll('.input-with-unit input')[1].value) / 100;

            const channelInputs = document.querySelectorAll('.table:last-of-type .input-small');
            const buyFormula = {
              buyPercentage,
              mediaWeight,
              sleeveWeight,
              priceStatistic: 'MEDIAN', // From form select
              channelMultipliers: {
                WEB: parseFloat(channelInputs[0].value),
                WALK_IN: parseFloat(channelInputs[1].value),
                BULK: parseFloat(channelInputs[2].value),
              },
            };

            // Sell formula (same structure for consistency)
            const sellFormula = {
              sellPercentage: 1.0, // Not used in buyer policy
              mediaWeight,
              sleeveWeight,
            };

            const minOffer = parseFloat(document.querySelectorAll('.form-group input[type="number"]')[5].value);
            const maxOffer = parseFloat(document.querySelectorAll('.form-group input[type="number"]')[6].value);
            const offerExpiryDays = parseInt(document.querySelectorAll('.form-group input[type="number"]')[7].value);

            const payload = {
              name: policyName || 'Standard Global',
              buyFormula,
              sellFormula,
              conditionCurve,
              minOffer,
              maxOffer,
              offerExpiryDays,
            };

            // Send to API
            const response = await fetch(`/api/v1/admin/pricing/${this.policyType}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.authToken}`,
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error?.message || 'Failed to save policy');
            }

            const result = await response.json();
            alert(`‚úì Policy saved successfully!\nVersion: ${result.data.version}`);
          } catch (error) {
            console.error('Error saving policy:', error);
            alert(`Error: ${error.message}`);
          }
        },

        resetToDefault() {
          if (confirm('Reset all values to defaults?')) {
            this.populateForm({
              name: 'Standard Global',
              buyFormula: {
                buyPercentage: 0.55,
                mediaWeight: 0.70,
                sleeveWeight: 0.30,
                channelMultipliers: { WEB: 1.0, WALK_IN: 0.95, BULK: 0.85 },
              },
              conditionCurve: {
                MINT: 1.15,
                NM: 1.0,
                VG_PLUS: 0.80,
                VG: 0.65,
                VG_MINUS: 0.50,
                G: 0.30,
              },
              minOffer: 5.00,
              maxOffer: 500.00,
              offerExpiryDays: 14,
            });
          }
        },
      };

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => buyerPricingManager.init());
      } else {
        buyerPricingManager.init();
      }
    </script>
  </body>
</html>
