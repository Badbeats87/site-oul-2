<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pricing Policy Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .header-status {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.success {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.error {
      background: #f8d7da;
      color: #721c24;
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      flex-direction: column;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab-button {
      padding: 12px 16px;
      border: none;
      background: #f5f5f5;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      text-align: left;
    }

    .tab-button:hover {
      background: #e8e8e8;
    }

    .tab-button.active {
      background: #667eea;
      color: white;
    }

    .content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .formula-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .formula-section h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 16px;
    }

    .formula-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .condition-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .condition-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }

    .condition-item label {
      margin-bottom: 5px;
      font-size: 13px;
    }

    .condition-item input {
      margin-bottom: 0;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e8e8e8;
    }

    .message {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #999;
    }

    .history {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #eee;
    }

    .history h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .history-item {
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .history-item .version {
      font-weight: 600;
      color: #667eea;
    }

    .history-item .date {
      color: #999;
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .main {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: row;
        overflow-x: auto;
      }

      .tab-button {
        white-space: nowrap;
      }

      .formula-grid, .condition-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pricing Policy Dashboard</h1>
      <div class="header-status">
        <div class="status-item">
          <span>Authentication:</span>
          <span class="status-badge" id="auth-status">Not authenticated</span>
        </div>
        <div class="status-item">
          <span>Active Policy:</span>
          <span id="active-policy" style="font-weight: 600;">Loading...</span>
        </div>
      </div>
    </header>

    <div class="main">
      <div class="sidebar">
        <div class="tabs">
          <button class="tab-button active" data-tab="buyer">Buyer Policy</button>
          <button class="tab-button" data-tab="seller">Seller Policy</button>
          <button class="tab-button" data-tab="login">Login</button>
        </div>
      </div>

      <div class="content">
        <!-- Login Tab -->
        <div id="login-tab" class="tab-content" style="display: none;">
          <h2>Admin Login</h2>
          <div class="message" id="login-message"></div>
          <form id="login-form">
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" value="admin@vinylcatalog.com" required>
            </div>
            <div class="form-group">
              <label>Password</label>
              <input type="password" id="password" value="Admin123!" required>
            </div>
            <button type="submit" class="btn-primary">Login</button>
          </form>
        </div>

        <!-- Buyer/Seller Policy Tabs -->
        <div id="buyer-tab" class="tab-content">
          <h2>Buyer Pricing Policy</h2>
          <p style="color: #666; margin-bottom: 20px;">Set the pricing rules for buying vinyl records from sellers</p>
          <div class="message" id="buyer-message"></div>
          <form id="buyer-form" style="display: none;">
            <div class="form-group">
              <label>Policy Name</label>
              <input type="text" id="buyer-name" value="Global Buyer Policy" required>
            </div>

            <!-- Buy Formula -->
            <div class="formula-section">
              <h3>Buy Formula (what we pay sellers)</h3>
              <div class="formula-grid">
                <div class="form-group">
                  <label>Buy Percentage (%)</label>
                  <input type="number" id="buyer-buy-percentage" step="0.01" min="0" max="100" placeholder="e.g., 55">
                </div>
                <div class="form-group">
                  <label>Price Statistic</label>
                  <select id="buyer-buy-stat">
                    <option value="MEDIAN">Median</option>
                    <option value="AVERAGE">Average</option>
                    <option value="LOW">Low</option>
                    <option value="HIGH">High</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-top: 15px;">
                <label>Media Grade Weight (0-1)</label>
                <input type="number" id="buyer-buy-media-weight" step="0.01" min="0" max="1" placeholder="e.g., 0.6">
              </div>
              <div class="form-group">
                <label>Sleeve Grade Weight (0-1)</label>
                <input type="number" id="buyer-buy-sleeve-weight" step="0.01" min="0" max="1" placeholder="e.g., 0.4">
              </div>
            </div>

            <!-- Sell Formula -->
            <div class="formula-section">
              <h3>Sell Formula (optional, what we sell for)</h3>
              <div class="formula-grid">
                <div class="form-group">
                  <label>Sell Percentage (%)</label>
                  <input type="number" id="buyer-sell-percentage" step="0.01" min="0" max="100" placeholder="e.g., 0">
                </div>
              </div>
            </div>

            <!-- Condition Curve -->
            <div class="formula-section">
              <h3>Condition Grade Multipliers</h3>
              <p style="color: #999; margin-bottom: 15px; font-size: 13px;">How much each grade affects the price (1.0 = base price)</p>
              <div class="condition-grid">
                <div class="condition-item">
                  <label>Mint (M)</label>
                  <input type="number" id="buyer-cond-MINT" step="0.01" min="0" placeholder="1.1">
                </div>
                <div class="condition-item">
                  <label>Near Mint (NM)</label>
                  <input type="number" id="buyer-cond-NM" step="0.01" min="0" placeholder="1.0">
                </div>
                <div class="condition-item">
                  <label>Very Good Plus (VG+)</label>
                  <input type="number" id="buyer-cond-VG_PLUS" step="0.01" min="0" placeholder="0.85">
                </div>
                <div class="condition-item">
                  <label>Very Good (VG)</label>
                  <input type="number" id="buyer-cond-VG" step="0.01" min="0" placeholder="0.6">
                </div>
                <div class="condition-item">
                  <label>Very Good Minus (VG-)</label>
                  <input type="number" id="buyer-cond-VG_MINUS" step="0.01" min="0" placeholder="0.45">
                </div>
                <div class="condition-item">
                  <label>Good (G)</label>
                  <input type="number" id="buyer-cond-G" step="0.01" min="0" placeholder="0.3">
                </div>
                <div class="condition-item">
                  <label>Fair (F)</label>
                  <input type="number" id="buyer-cond-FAIR" step="0.01" min="0" placeholder="0.2">
                </div>
                <div class="condition-item">
                  <label>Poor (P)</label>
                  <input type="number" id="buyer-cond-POOR" step="0.01" min="0" placeholder="0.1">
                </div>
              </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label>Min Offer ($)</label>
              <input type="number" id="buyer-min-offer" step="0.01" min="0" placeholder="e.g., 5.00">
            </div>

            <div class="form-group">
              <label>Max Offer ($)</label>
              <input type="number" id="buyer-max-offer" step="0.01" min="0" placeholder="e.g., 500.00">
            </div>

            <div class="form-group">
              <label>Offer Expiry (days)</label>
              <input type="number" id="buyer-offer-expiry" min="1" placeholder="e.g., 30">
            </div>

            <div class="button-group">
              <button type="submit" class="btn-primary">Save Buyer Policy</button>
              <button type="button" class="btn-secondary" id="buyer-reload">Reload</button>
            </div>
          </form>
          <div id="buyer-loading" class="loading">Loading buyer policy...</div>

          <div class="history" id="buyer-history" style="display: none;">
            <h3>Version History</h3>
            <div id="buyer-history-list"></div>
          </div>
        </div>

        <div id="seller-tab" class="tab-content" style="display: none;">
          <h2>Seller Pricing Policy</h2>
          <p style="color: #666; margin-bottom: 20px;">Set the default pricing for records in inventory</p>
          <div class="message" id="seller-message"></div>
          <form id="seller-form" style="display: none;">
            <div class="form-group">
              <label>Policy Name</label>
              <input type="text" id="seller-name" value="Global Seller Policy" required>
            </div>

            <!-- Sell Formula -->
            <div class="formula-section">
              <h3>Sell Formula (what we sell for)</h3>
              <div class="formula-grid">
                <div class="form-group">
                  <label>Sell Percentage (%)</label>
                  <input type="number" id="seller-sell-percentage" step="0.01" min="0" max="100" placeholder="e.g., 120">
                </div>
                <div class="form-group">
                  <label>Price Statistic</label>
                  <select id="seller-sell-stat">
                    <option value="MEDIAN">Median</option>
                    <option value="AVERAGE">Average</option>
                    <option value="LOW">Low</option>
                    <option value="HIGH">High</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-top: 15px;">
                <label>Media Grade Weight (0-1)</label>
                <input type="number" id="seller-sell-media-weight" step="0.01" min="0" max="1" placeholder="e.g., 0.6">
              </div>
              <div class="form-group">
                <label>Sleeve Grade Weight (0-1)</label>
                <input type="number" id="seller-sell-sleeve-weight" step="0.01" min="0" max="1" placeholder="e.g., 0.4">
              </div>
            </div>

            <!-- Condition Curve -->
            <div class="formula-section">
              <h3>Condition Grade Multipliers</h3>
              <p style="color: #999; margin-bottom: 15px; font-size: 13px;">How much each grade affects the price (1.0 = base price)</p>
              <div class="condition-grid">
                <div class="condition-item">
                  <label>Mint (M)</label>
                  <input type="number" id="seller-cond-MINT" step="0.01" min="0" placeholder="1.1">
                </div>
                <div class="condition-item">
                  <label>Near Mint (NM)</label>
                  <input type="number" id="seller-cond-NM" step="0.01" min="0" placeholder="1.0">
                </div>
                <div class="condition-item">
                  <label>Very Good Plus (VG+)</label>
                  <input type="number" id="seller-cond-VG_PLUS" step="0.01" min="0" placeholder="0.85">
                </div>
                <div class="condition-item">
                  <label>Very Good (VG)</label>
                  <input type="number" id="seller-cond-VG" step="0.01" min="0" placeholder="0.6">
                </div>
                <div class="condition-item">
                  <label>Very Good Minus (VG-)</label>
                  <input type="number" id="seller-cond-VG_MINUS" step="0.01" min="0" placeholder="0.45">
                </div>
                <div class="condition-item">
                  <label>Good (G)</label>
                  <input type="number" id="seller-cond-G" step="0.01" min="0" placeholder="0.3">
                </div>
                <div class="condition-item">
                  <label>Fair (F)</label>
                  <input type="number" id="seller-cond-FAIR" step="0.01" min="0" placeholder="0.2">
                </div>
                <div class="condition-item">
                  <label>Poor (P)</label>
                  <input type="number" id="seller-cond-POOR" step="0.01" min="0" placeholder="0.1">
                </div>
              </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label>Offer Expiry (days)</label>
              <input type="number" id="seller-offer-expiry" min="1" placeholder="e.g., 30">
            </div>

            <div class="button-group">
              <button type="submit" class="btn-primary">Save Seller Policy</button>
              <button type="button" class="btn-secondary" id="seller-reload">Reload</button>
            </div>
          </form>
          <div id="seller-loading" class="loading">Loading seller policy...</div>

          <div class="history" id="seller-history" style="display: none;">
            <h3>Version History</h3>
            <div id="seller-history-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let authToken = localStorage.getItem('authToken');
    const API_BASE = '/api/v1';

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        btn.classList.add('active');
        const tabId = btn.dataset.tab + '-tab';
        document.getElementById(tabId).style.display = 'block';

        if (btn.dataset.tab === 'login') {
          // Reset login form
        } else if (authToken) {
          loadPolicy(btn.dataset.tab);
        }
      });
    });

    // Login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();

        if (res.ok) {
          authToken = data.data.accessToken;
          localStorage.setItem('authToken', authToken);
          updateAuthStatus();
          showMessage('login-message', 'Login successful!', 'success');
          setTimeout(() => loadPolicy('buyer'), 1000);
        } else {
          showMessage('login-message', data.message || 'Login failed', 'error');
        }
      } catch (err) {
        showMessage('login-message', 'Network error: ' + err.message, 'error');
      }
    });

    // Load policy
    async function loadPolicy(type) {
      const form = document.getElementById(`${type}-form`);
      const loading = document.getElementById(`${type}-loading`);
      const message = document.getElementById(`${type}-message`);

      if (!authToken) {
        message.textContent = 'Please login first';
        message.className = 'message error';
        message.style.display = 'block';
        return;
      }

      loading.style.display = 'block';
      form.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/admin/pricing/${type.toUpperCase()}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (res.ok && data.data) {
          populateForm(type, data.data);
          form.style.display = 'block';
          message.style.display = 'none';
          loadPolicyHistory(type);
        } else {
          showMessage(`${type}-message`, 'Failed to load policy', 'error');
        }
      } catch (err) {
        showMessage(`${type}-message`, 'Network error: ' + err.message, 'error');
      } finally {
        loading.style.display = 'none';
      }
    }

    // Populate form
    function populateForm(type, policy) {
      document.getElementById(`${type}-name`).value = policy.name || '';
      // Convert decimal percentages (0.55) to whole numbers (55) for display
      document.getElementById(`${type}-buy-percentage`).value = policy.buyFormula?.percentage ? policy.buyFormula.percentage * 100 : '';
      document.getElementById(`${type}-sell-percentage`).value = policy.sellFormula?.percentage ? policy.sellFormula.percentage * 100 : '';
      document.getElementById(`${type}-buy-media-weight`).value = policy.buyFormula?.weights?.media || '';
      document.getElementById(`${type}-buy-sleeve-weight`).value = policy.buyFormula?.weights?.sleeve || '';
      document.getElementById(`${type}-sell-media-weight`).value = policy.sellFormula?.weights?.media || '';
      document.getElementById(`${type}-sell-sleeve-weight`).value = policy.sellFormula?.weights?.sleeve || '';
      document.getElementById(`${type}-min-offer`).value = policy.minOffer || '';
      document.getElementById(`${type}-max-offer`).value = policy.maxOffer || '';
      document.getElementById(`${type}-offer-expiry`).value = policy.offerExpiryDays || 30;

      // Condition curve
      Object.entries(policy.conditionCurve || {}).forEach(([grade, multiplier]) => {
        const el = document.getElementById(`${type}-cond-${grade}`);
        if (el) el.value = multiplier;
      });
    }

    // Save policy
    ['buyer', 'seller'].forEach(type => {
      document.getElementById(`${type}-form`).addEventListener('submit', async (e) => {
        e.preventDefault();

        const conditionCurve = {};
        ['MINT', 'NM', 'VG_PLUS', 'VG', 'VG_MINUS', 'G', 'FAIR', 'POOR'].forEach(grade => {
          const val = document.getElementById(`${type}-cond-${grade}`).value;
          if (val) conditionCurve[grade] = parseFloat(val);
        });

        const payload = {
          name: document.getElementById(`${type}-name`).value,
          buyFormula: {
            percentage: parseFloat(document.getElementById(`${type}-buy-percentage`).value) / 100,
            weights: {
              media: parseFloat(document.getElementById(`${type}-buy-media-weight`).value),
              sleeve: parseFloat(document.getElementById(`${type}-buy-sleeve-weight`).value)
            }
          },
          sellFormula: {
            percentage: parseFloat(document.getElementById(`${type}-sell-percentage`).value) / 100,
            weights: {
              media: parseFloat(document.getElementById(`${type}-sell-media-weight`).value),
              sleeve: parseFloat(document.getElementById(`${type}-sell-sleeve-weight`).value)
            }
          },
          conditionCurve,
          minOffer: document.getElementById(`${type}-min-offer`).value || null,
          maxOffer: document.getElementById(`${type}-max-offer`).value || null,
          offerExpiryDays: parseInt(document.getElementById(`${type}-offer-expiry`).value) || 30
        };

        try {
          const res = await fetch(`${API_BASE}/admin/pricing/${type.toUpperCase()}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json();

          if (res.ok) {
            showMessage(`${type}-message`, `${type.charAt(0).toUpperCase() + type.slice(1)} policy saved (v${data.data.version})`, 'success');
            updateAuthStatus();
            loadPolicyHistory(type);
          } else {
            showMessage(`${type}-message`, data.message || 'Failed to save policy', 'error');
          }
        } catch (err) {
          showMessage(`${type}-message`, 'Network error: ' + err.message, 'error');
        }
      });

      // Reload button
      document.getElementById(`${type}-reload`).addEventListener('click', () => loadPolicy(type));
    });

    // Load history
    async function loadPolicyHistory(type) {
      if (!authToken) return;

      try {
        const res = await fetch(`${API_BASE}/admin/pricing/${type.toUpperCase()}/history`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (res.ok && data.data) {
          const history = document.getElementById(`${type}-history`);
          const list = document.getElementById(`${type}-history-list`);
          list.innerHTML = data.data.map(p => `
            <div class="history-item">
              <div><span class="version">v${p.version}</span> ${p.isActive ? '(Active)' : ''}</div>
              <div class="date">${new Date(p.createdAt).toLocaleString()}</div>
            </div>
          `).join('');
          history.style.display = 'block';
        }
      } catch (err) {
        console.error('Failed to load history:', err);
      }
    }

    // Utilities
    function showMessage(elementId, text, type) {
      const el = document.getElementById(elementId);
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
    }

    function updateAuthStatus() {
      const status = document.getElementById('auth-status');
      if (authToken) {
        status.textContent = 'Authenticated';
        status.className = 'status-badge success';
      } else {
        status.textContent = 'Not authenticated';
        status.className = 'status-badge error';
      }
    }

    // Initialize
    updateAuthStatus();
    if (authToken) {
      loadPolicy('buyer');
    } else {
      document.querySelector('[data-tab="login"]').click();
    }
  </script>
</body>
</html>
