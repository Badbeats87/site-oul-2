generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CATALOG ENTITIES
// ============================================================================

model Release {
  id              String   @id @default(uuid()) @db.Uuid
  title           String   @db.VarChar(500)
  artist          String   @db.VarChar(500)
  label           String?  @db.VarChar(255)
  catalogNumber   String?  @map("catalog_number") @db.VarChar(100)
  barcode         String?  @db.VarChar(50)
  releaseYear     Int?     @map("release_year")
  genre           String?  @db.VarChar(100)
  coverArtUrl     String?  @map("cover_art_url") @db.VarChar(1000)
  description     String?  @db.Text

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketSnapshots    MarketSnapshot[]
  releasePolicies    ReleasePricingPolicy[]
  submissionItems    SubmissionItem[]
  inventoryLots      InventoryLot[]

  // Indexes
  @@index([artist, title])
  @@index([barcode])
  @@index([catalogNumber])
  @@index([genre])
  @@index([releaseYear])
  @@index([createdAt])
  @@index([genre, releaseYear])
  @@map("releases")
}

// ============================================================================
// MARKET DATA
// ============================================================================

model MarketSnapshot {
  id          String   @id @default(uuid()) @db.Uuid
  releaseId   String   @map("release_id") @db.Uuid
  source      MarketSource
  statLow     Decimal? @map("stat_low") @db.Decimal(10, 2)
  statMedian  Decimal? @map("stat_median") @db.Decimal(10, 2)
  statHigh    Decimal? @map("stat_high") @db.Decimal(10, 2)
  sampleSize  Int?     @map("sample_size")
  fetchedAt   DateTime @map("fetched_at") @db.Timestamptz

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  release     Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([releaseId, fetchedAt(sort: Desc)])
  @@index([source, fetchedAt(sort: Desc)])
  @@map("market_snapshots")
}

enum MarketSource {
  DISCOGS
  EBAY
  HYBRID
  MANUAL
}

// ============================================================================
// PRICING POLICIES
// ============================================================================

model PricingPolicy {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @db.VarChar(255)
  scope             PolicyScope
  isActive          Boolean  @default(true) @map("is_active")
  version           Int      @default(1)

  // Formula configurations (stored as JSON)
  buyFormula        Json     @map("buy_formula")
  sellFormula       Json     @map("sell_formula")
  conditionCurve    Json     @map("condition_curve")

  // Policy parameters
  minOffer          Decimal? @map("min_offer") @db.Decimal(10, 2)
  maxOffer          Decimal? @map("max_offer") @db.Decimal(10, 2)
  offerExpiryDays   Int      @default(30) @map("offer_expiry_days")

  // Genre-specific scope
  genreScope        String?  @map("genre_scope") @db.VarChar(100)

  // Channel-specific scope
  channelScope      String?  @map("channel_scope") @db.VarChar(50)

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy         String?  @map("created_by") @db.Uuid

  // Relations
  releasePolicies   ReleasePricingPolicy[]
  policyAudits      PricingPolicyAudit[]

  // Indexes
  @@index([scope, isActive])
  @@index([genreScope, isActive])
  @@map("pricing_policies")
}

enum PolicyScope {
  GLOBAL
  GENRE
  RELEASE
  CHANNEL
}

// Junction table for release-specific policies
model ReleasePricingPolicy {
  id              String   @id @default(uuid()) @db.Uuid
  releaseId       String   @map("release_id") @db.Uuid
  policyId        String   @map("policy_id") @db.Uuid
  priority        Int      @default(0)
  isActive        Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  release         Release        @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  policy          PricingPolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // Unique constraint
  @@unique([releaseId, policyId])
  @@index([releaseId, isActive])
  @@map("release_pricing_policies")
}

// Audit trail for pricing policy changes
model PricingPolicyAudit {
  id              String   @id @default(uuid()) @db.Uuid
  policyId        String   @map("policy_id") @db.Uuid
  changeType      String   @map("change_type") @db.VarChar(50)
  previousVersion Int?     @map("previous_version")
  newVersion      Int      @map("new_version")
  changes         Json     // Stores the diff of what changed
  changedBy       String?  @map("changed_by") @db.Uuid
  changedAt       DateTime @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  policy          PricingPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([policyId, changedAt(sort: Desc)])
  @@map("pricing_policy_audits")
}

// ============================================================================
// SELLER SUBMISSIONS
// ============================================================================

model SellerSubmission {
  id              String   @id @default(uuid()) @db.Uuid
  sellerContact   String   @map("seller_contact") @db.VarChar(255)
  sellerName      String?  @map("seller_name") @db.VarChar(255)
  sellerNotes     String?  @map("seller_notes") @db.Text
  status          SubmissionStatus @default(PENDING_REVIEW)

  // Total value calculations
  totalOffered    Decimal? @map("total_offered") @db.Decimal(10, 2)
  totalAccepted   Decimal? @map("total_accepted") @db.Decimal(10, 2)

  // Submission channel
  channel         String?  @db.VarChar(50)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz
  expiresAt       DateTime @map("expires_at") @db.Timestamptz
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz
  reviewedBy      String?  @map("reviewed_by") @db.Uuid

  // Relations
  items           SubmissionItem[]
  audits          SubmissionAudit[]

  // Indexes
  @@index([status, createdAt(sort: Desc)])
  @@index([sellerContact])
  @@index([expiresAt])
  @@map("seller_submissions")
}

enum SubmissionStatus {
  PENDING_REVIEW
  COUNTER_OFFERED
  ACCEPTED
  PARTIALLY_ACCEPTED
  REJECTED
  EXPIRED
  COMPLETED
}

// Audit trail for submission state changes
model SubmissionAudit {
  id              String   @id @default(uuid()) @db.Uuid
  submissionId    String   @map("submission_id") @db.Uuid
  fromStatus      SubmissionStatus @map("from_status")
  toStatus        SubmissionStatus @map("to_status")
  changeReason    String?  @map("change_reason") @db.VarChar(255)
  changedBy       String?  @map("changed_by") @db.Uuid
  changedAt       DateTime @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  submission      SellerSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([submissionId, changedAt(sort: Desc)])
  @@index([changedAt(sort: Desc)])
  @@map("submission_audits")
}

model SubmissionItem {
  id                    String   @id @default(uuid()) @db.Uuid
  submissionId          String   @map("submission_id") @db.Uuid
  releaseId             String   @map("release_id") @db.Uuid
  quantity              Int      @default(1)

  // Condition grades
  sellerConditionMedia  VinylCondition @map("seller_condition_media")
  sellerConditionSleeve VinylCondition @map("seller_condition_sleeve")

  // Pricing
  autoOfferPrice        Decimal  @map("auto_offer_price") @db.Decimal(10, 2)
  counterOfferPrice     Decimal? @map("counter_offer_price") @db.Decimal(10, 2)
  finalOfferPrice       Decimal? @map("final_offer_price") @db.Decimal(10, 2)

  // Policy tracking
  policyIdUsed          String?  @map("policy_id_used") @db.Uuid
  policyVersionUsed     Int?     @map("policy_version_used")

  // Item status
  status                ItemStatus @default(PENDING)
  notes                 String?  @db.Text

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  submission            SellerSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  release               Release          @relation(fields: [releaseId], references: [id], onDelete: Restrict)
  inventoryLots         InventoryLot[]

  // Indexes
  @@index([submissionId])
  @@index([releaseId])
  @@index([status])
  @@map("submission_items")
}

enum ItemStatus {
  PENDING
  ACCEPTED
  COUNTER_OFFERED
  REJECTED
  CONVERTED_TO_INVENTORY
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model InventoryLot {
  id                String   @id @default(uuid()) @db.Uuid
  releaseId         String   @map("release_id") @db.Uuid
  submissionItemId  String?  @map("submission_item_id") @db.Uuid

  // Condition (may differ from submission after inspection)
  conditionMedia    VinylCondition @map("condition_media")
  conditionSleeve   VinylCondition @map("condition_sleeve")

  // Pricing
  costBasis         Decimal  @map("cost_basis") @db.Decimal(10, 2)
  listPrice         Decimal  @map("list_price") @db.Decimal(10, 2)
  salePrice         Decimal? @map("sale_price") @db.Decimal(10, 2)

  // Inventory details
  channel           String?  @db.VarChar(50)
  status            LotStatus @default(DRAFT)
  sku               String?  @unique @db.VarChar(100)

  // Merchandising
  internalNotes     String?  @map("internal_notes") @db.Text
  publicDescription String?  @map("public_description") @db.Text
  photoUrls         Json?    @map("photo_urls")

  // Sales tracking
  reservedAt        DateTime? @map("reserved_at") @db.Timestamptz
  soldAt            DateTime? @map("sold_at") @db.Timestamptz
  orderId           String?   @map("order_id") @db.Uuid

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  listedAt          DateTime? @map("listed_at") @db.Timestamptz

  // Relations
  release           Release          @relation(fields: [releaseId], references: [id], onDelete: Restrict)
  submissionItem    SubmissionItem?  @relation(fields: [submissionItemId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([releaseId, status])
  @@index([status, listedAt(sort: Desc)])
  @@index([sku])
  @@map("inventory_lots")
}

enum LotStatus {
  DRAFT
  LIVE
  RESERVED
  SOLD
  REMOVED
  RETURNED
}

enum VinylCondition {
  MINT
  NM          // Near Mint
  VG_PLUS     // Very Good Plus
  VG          // Very Good
  VG_MINUS    // Very Good Minus
  G           // Good
  FAIR
  POOR
}

// ============================================================================
// USER AUTHENTICATION & AUTHORIZATION
// ============================================================================

enum UserRole {
  SUPER_ADMIN  // Full system access, manage users
  ADMIN        // Manage catalog, pricing, inventory
  SELLER       // Submit items, view own submissions
  BUYER        // Browse catalog, place orders
}

// ============================================================================
// ADMIN USERS (for audit tracking)
// ============================================================================

model AdminUser {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  name            String   @db.VarChar(255)
  role            UserRole @default(BUYER)
  passwordHash    String   @map("password_hash") @db.VarChar(255)
  isActive        Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz
  lastLoginAt     DateTime? @map("last_login_at") @db.Timestamptz

  // Relations
  refreshTokens   RefreshToken[]

  @@index([email])
  @@index([role, isActive])
  @@map("admin_users")
}

// Refresh tokens for session management and revocation
model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  token       String   @unique @db.VarChar(500)
  userId      String   @map("user_id") @db.Uuid
  expiresAt   DateTime @map("expires_at") @db.Timestamptz
  revokedAt   DateTime? @map("revoked_at") @db.Timestamptz
  replacedBy  String?  @map("replaced_by") @db.Uuid

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user        AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
