generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CATALOG ENTITIES
// ============================================================================

model Release {
  id              String   @id @default(uuid()) @db.Uuid
  title           String   @db.VarChar(500)
  artist          String   @db.VarChar(500)
  label           String?  @db.VarChar(255)
  catalogNumber   String?  @map("catalog_number") @db.VarChar(100)
  barcode         String?  @db.VarChar(50)
  releaseYear     Int?     @map("release_year")
  genre           String?  @db.VarChar(100)
  coverArtUrl     String?  @map("cover_art_url") @db.VarChar(1000)
  description     String?  @db.Text
  discogsId       Int?     @map("discogs_id") @unique

  // Full-text search (tsvector for PostgreSQL)
  searchVector    Unsupported("tsvector")? @map("search_vector")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  marketSnapshots    MarketSnapshot[]
  releasePolicies    ReleasePricingPolicy[]
  submissionItems    SubmissionItem[]
  inventoryLots      InventoryLot[]

  // Indexes
  @@index([artist, title])
  @@index([barcode])
  @@index([catalogNumber])
  @@index([genre])
  @@index([releaseYear])
  @@index([createdAt])
  @@index([genre, releaseYear])
  @@index([discogsId])
  @@map("releases")
}

// ============================================================================
// MARKET DATA
// ============================================================================

model MarketSnapshot {
  id          String   @id @default(uuid()) @db.Uuid
  releaseId   String   @map("release_id") @db.Uuid
  source      MarketSource
  statLow     Decimal? @map("stat_low") @db.Decimal(10, 2)
  statMedian  Decimal? @map("stat_median") @db.Decimal(10, 2)
  statHigh    Decimal? @map("stat_high") @db.Decimal(10, 2)
  sampleSize  Int?     @map("sample_size")
  fetchedAt   DateTime @map("fetched_at") @db.Timestamptz

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  release     Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([releaseId, fetchedAt(sort: Desc)])
  @@index([source, fetchedAt(sort: Desc)])
  @@map("market_snapshots")
}

enum MarketSource {
  DISCOGS
  EBAY
  HYBRID
  MANUAL
}

// ============================================================================
// PRICING POLICIES
// ============================================================================

model PricingPolicy {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @db.VarChar(255)
  scope             PolicyScope
  isActive          Boolean  @default(true) @map("is_active")
  version           Int      @default(1)

  // Formula configurations (stored as JSON)
  buyFormula        Json     @map("buy_formula")
  sellFormula       Json     @map("sell_formula")
  conditionCurve    Json     @map("condition_curve")

  // Policy parameters
  minOffer          Decimal? @map("min_offer") @db.Decimal(10, 2)
  maxOffer          Decimal? @map("max_offer") @db.Decimal(10, 2)
  offerExpiryDays   Int      @default(30) @map("offer_expiry_days")

  // Genre-specific scope
  genreScope        String?  @map("genre_scope") @db.VarChar(100)

  // Channel-specific scope
  channelScope      String?  @map("channel_scope") @db.VarChar(50)

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy         String?  @map("created_by") @db.Uuid

  // Relations
  releasePolicies   ReleasePricingPolicy[]
  policyAudits      PricingPolicyAudit[]

  // Indexes
  @@index([scope, isActive])
  @@index([genreScope, isActive])
  @@map("pricing_policies")
}

enum PolicyScope {
  GLOBAL
  GENRE
  RELEASE
  CHANNEL
  BUYER
  SELLER
}

// Junction table for release-specific policies
model ReleasePricingPolicy {
  id              String   @id @default(uuid()) @db.Uuid
  releaseId       String   @map("release_id") @db.Uuid
  policyId        String   @map("policy_id") @db.Uuid
  priority        Int      @default(0)
  isActive        Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  release         Release        @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  policy          PricingPolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // Unique constraint
  @@unique([releaseId, policyId])
  @@index([releaseId, isActive])
  @@map("release_pricing_policies")
}

// Audit trail for pricing policy changes
model PricingPolicyAudit {
  id              String   @id @default(uuid()) @db.Uuid
  policyId        String   @map("policy_id") @db.Uuid
  changeType      String   @map("change_type") @db.VarChar(50)
  previousVersion Int?     @map("previous_version")
  newVersion      Int      @map("new_version")
  changes         Json     // Stores the diff of what changed
  changedBy       String?  @map("changed_by") @db.Uuid
  changedAt       DateTime @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  policy          PricingPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([policyId, changedAt(sort: Desc)])
  @@map("pricing_policy_audits")
}

// ============================================================================
// SELLER SUBMISSIONS
// ============================================================================

model SellerSubmission {
  id              String   @id @default(uuid()) @db.Uuid
  sellerContact   String   @map("seller_contact") @db.VarChar(255)
  sellerName      String?  @map("seller_name") @db.VarChar(255)
  sellerNotes     String?  @map("seller_notes") @db.Text
  status          SubmissionStatus @default(PENDING_REVIEW)

  // Total value calculations
  totalOffered    Decimal? @map("total_offered") @db.Decimal(10, 2)
  totalAccepted   Decimal? @map("total_accepted") @db.Decimal(10, 2)

  // Submission channel
  channel         String?  @db.VarChar(50)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz
  expiresAt       DateTime @map("expires_at") @db.Timestamptz
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz
  reviewedBy      String?  @map("reviewed_by") @db.Uuid

  // Relations
  items           SubmissionItem[]
  audits          SubmissionAudit[]

  // Indexes
  @@index([status, createdAt(sort: Desc)])
  @@index([sellerContact])
  @@index([expiresAt])
  @@map("seller_submissions")
}

enum SubmissionStatus {
  PENDING_REVIEW
  COUNTER_OFFERED
  ACCEPTED
  PARTIALLY_ACCEPTED
  REJECTED
  EXPIRED
  COMPLETED
}

// Audit trail for submission state changes
model SubmissionAudit {
  id              String   @id @default(uuid()) @db.Uuid
  submissionId    String   @map("submission_id") @db.Uuid
  fromStatus      SubmissionStatus @map("from_status")
  toStatus        SubmissionStatus @map("to_status")
  changeReason    String?  @map("change_reason") @db.VarChar(255)
  changedBy       String?  @map("changed_by") @db.Uuid
  changedAt       DateTime @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  submission      SellerSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([submissionId, changedAt(sort: Desc)])
  @@index([changedAt(sort: Desc)])
  @@map("submission_audits")
}

model SubmissionItem {
  id                    String   @id @default(uuid()) @db.Uuid
  submissionId          String   @map("submission_id") @db.Uuid
  releaseId             String   @map("release_id") @db.Uuid
  quantity              Int      @default(1)

  // Condition grades
  sellerConditionMedia  VinylCondition @map("seller_condition_media")
  sellerConditionSleeve VinylCondition @map("seller_condition_sleeve")

  // Pricing
  autoOfferPrice        Decimal  @map("auto_offer_price") @db.Decimal(10, 2)
  counterOfferPrice     Decimal? @map("counter_offer_price") @db.Decimal(10, 2)
  finalOfferPrice       Decimal? @map("final_offer_price") @db.Decimal(10, 2)

  // Policy tracking
  policyIdUsed          String?  @map("policy_id_used") @db.Uuid
  policyVersionUsed     Int?     @map("policy_version_used")

  // Item status
  status                ItemStatus @default(PENDING)
  notes                 String?  @db.Text

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  submission            SellerSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  release               Release          @relation(fields: [releaseId], references: [id], onDelete: Restrict)
  inventoryLots         InventoryLot[]

  // Indexes
  @@index([submissionId])
  @@index([releaseId])
  @@index([status])
  @@map("submission_items")
}

enum ItemStatus {
  PENDING
  ACCEPTED
  COUNTER_OFFERED
  REJECTED
  CONVERTED_TO_INVENTORY
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

model InventoryLot {
  id                String   @id @default(uuid()) @db.Uuid
  releaseId         String   @map("release_id") @db.Uuid
  submissionItemId  String?  @map("submission_item_id") @db.Uuid

  // Condition (may differ from submission after inspection)
  conditionMedia    VinylCondition @map("condition_media")
  conditionSleeve   VinylCondition @map("condition_sleeve")

  // Pricing
  costBasis         Decimal  @map("cost_basis") @db.Decimal(10, 2)
  listPrice         Decimal  @map("list_price") @db.Decimal(10, 2)
  salePrice         Decimal? @map("sale_price") @db.Decimal(10, 2)

  // Inventory details
  channel           String?  @db.VarChar(50)
  status            LotStatus @default(DRAFT)
  sku               String?  @unique @db.VarChar(100)

  // Merchandising
  internalNotes     String?  @map("internal_notes") @db.Text
  publicDescription String?  @map("public_description") @db.Text
  photoUrls         Json?    @map("photo_urls")

  // Sales tracking
  reservedAt        DateTime? @map("reserved_at") @db.Timestamptz
  soldAt            DateTime? @map("sold_at") @db.Timestamptz
  orderId           String?   @map("order_id") @db.Uuid

  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz
  listedAt          DateTime? @map("listed_at") @db.Timestamptz

  // Relations
  release           Release          @relation(fields: [releaseId], references: [id], onDelete: Restrict)
  submissionItem    SubmissionItem?  @relation(fields: [submissionItemId], references: [id], onDelete: SetNull)
  orderItems        OrderItem[]
  holds             InventoryHold[]

  // Indexes
  @@index([releaseId, status])
  @@index([status, listedAt(sort: Desc)])
  @@index([sku])
  @@map("inventory_lots")
}

enum LotStatus {
  DRAFT
  LIVE
  RESERVED
  SOLD
  REMOVED
  RETURNED
}

enum VinylCondition {
  MINT
  NM          // Near Mint
  VG_PLUS     // Very Good Plus
  VG          // Very Good
  VG_MINUS    // Very Good Minus
  G           // Good
  FAIR
  POOR
}

// ============================================================================
// ORDERS & CHECKOUT
// ============================================================================

enum OrderStatus {
  CART                // Initial state - items in cart
  PAYMENT_PENDING     // Payment intent created, awaiting confirmation
  PAYMENT_CONFIRMED   // Payment successful
  PROCESSING          // Order being prepared for shipment
  SHIPPED             // Order shipped to customer
  DELIVERED           // Order delivered
  CANCELLED           // Order cancelled
  PAYMENT_FAILED      // Payment failed
  REFUNDED            // Order refunded
}

model Order {
  id                     String      @id @default(uuid()) @db.Uuid
  orderNumber            String      @unique @db.VarChar(50)

  // Buyer Information (guest checkout supported)
  buyerEmail             String      @db.VarChar(255)
  buyerName              String?     @db.VarChar(255)
  buyerId                String?     @db.Uuid

  // Order Status
  status                 OrderStatus @default(CART)

  // Pricing
  subtotal               Decimal     @db.Decimal(10, 2)
  tax                    Decimal     @default(0) @db.Decimal(10, 2)
  shipping               Decimal     @default(0) @db.Decimal(10, 2)
  total                  Decimal     @db.Decimal(10, 2)

  // Payment
  stripePaymentIntentId  String?     @unique @map("stripe_payment_intent_id") @db.VarChar(255)
  stripePaymentStatus    String?     @map("stripe_payment_status") @db.VarChar(50)
  paymentMethod          String?     @map("payment_method") @db.VarChar(50)

  // Shipping Address
  shippingAddress        Json?
  shippingMethod         ShippingMethod? @map("shipping_method")

  // Metadata
  sessionId              String?     @db.VarChar(255)
  ipAddress              String?     @db.VarChar(50)
  userAgent              String?     @db.VarChar(500)

  // Timestamps
  createdAt              DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  checkoutStartedAt      DateTime?   @map("checkout_started_at") @db.Timestamptz
  paymentConfirmedAt     DateTime?   @map("payment_confirmed_at") @db.Timestamptz
  shippedAt              DateTime?   @map("shipped_at") @db.Timestamptz
  deliveredAt            DateTime?   @map("delivered_at") @db.Timestamptz

  // Relations
  items                  OrderItem[]
  audits                 OrderAudit[]
  shipment               Shipment?
  holds                  InventoryHold[]

  // Indexes
  @@index([buyerEmail])
  @@index([status, createdAt(sort: Desc)])
  @@index([stripePaymentIntentId])
  @@index([sessionId])
  @@map("orders")
}

model OrderItem {
  id                 String         @id @default(uuid()) @db.Uuid
  orderId            String         @map("order_id") @db.Uuid
  inventoryLotId     String         @map("inventory_lot_id") @db.Uuid

  // Snapshot pricing (preserve historical prices)
  priceAtPurchase    Decimal        @map("price_at_purchase") @db.Decimal(10, 2)

  // Product snapshot
  releaseTitle       String         @map("release_title") @db.VarChar(500)
  releaseArtist      String         @map("release_artist") @db.VarChar(500)
  conditionMedia     VinylCondition @map("condition_media")
  conditionSleeve    VinylCondition @map("condition_sleeve")

  // Timestamps
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  order              Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  inventoryLot       InventoryLot   @relation(fields: [inventoryLotId], references: [id], onDelete: Restrict)

  // Indexes
  @@index([orderId])
  @@index([inventoryLotId])
  @@map("order_items")
}

model OrderAudit {
  id           String      @id @default(uuid()) @db.Uuid
  orderId      String      @map("order_id") @db.Uuid
  fromStatus   OrderStatus @map("from_status")
  toStatus     OrderStatus @map("to_status")
  changeReason String?     @map("change_reason") @db.VarChar(255)
  changedBy    String?     @map("changed_by") @db.Uuid
  changedAt    DateTime    @default(now()) @map("changed_at") @db.Timestamptz

  // Relations
  order        Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([orderId, changedAt(sort: Desc)])
  @@index([changedAt(sort: Desc)])
  @@map("order_audits")
}

// Update Order model to include shipping fields
// (See extension at end of SHIPPING MANAGEMENT section)

// ============================================================================
// SHIPPING MANAGEMENT
// ============================================================================

enum ShippingMethod {
  STANDARD
  EXPRESS
  OVERNIGHT
}

enum ShipmentStatus {
  PENDING_LABEL        // Awaiting label generation
  LABEL_GENERATED      // Label created, pending approval
  READY_TO_SHIP        // Admin approved
  IN_TRANSIT           // Shipped, carrier has package
  OUT_FOR_DELIVERY     // Final delivery leg
  DELIVERED            // Successfully delivered
  FAILED_DELIVERY      // Delivery attempt failed
  RETURNED             // Returned to sender
  EXCEPTION            // Carrier exception
}

enum ShippingCarrier {
  MOCK
  USPS
  UPS
  FEDEX
  DHL
}

model Shipment {
  id                    String          @id @default(uuid()) @db.Uuid
  orderId               String          @unique @map("order_id") @db.Uuid

  // Status tracking
  shipmentStatus        ShipmentStatus  @map("shipment_status") @default(PENDING_LABEL)
  carrier               ShippingCarrier
  shippingMethod        ShippingMethod  @map("shipping_method")

  // Tracking info
  trackingNumber        String?         @unique @map("tracking_number") @db.VarChar(100)
  trackingUrl           String?         @map("tracking_url") @db.VarChar(500)

  // Label details
  labelUrl              String?         @map("label_url") @db.VarChar(500)
  labelFormat           String?         @map("label_format") @db.VarChar(20) // PDF, ZPL, PNG

  // Package details
  weightOz              Int             @map("weight_oz")
  packageType           String          @default("PACKAGE") @db.VarChar(50)
  dimensions            Json?           // {length, width, height, unit}

  // Pricing
  baseRate              Decimal         @map("base_rate") @db.Decimal(10, 2)
  insuranceCost         Decimal         @default(0) @map("insurance_cost") @db.Decimal(10, 2)
  totalCost             Decimal         @map("total_cost") @db.Decimal(10, 2)

  // Addresses (denormalized for historical accuracy)
  fromAddress           Json            @map("from_address")
  toAddress             Json            @map("to_address")

  // Provider integration (for Shippo/EasyPost)
  providerShipmentId    String?         @map("provider_shipment_id") @db.VarChar(100)
  providerRateId        String?         @map("provider_rate_id") @db.VarChar(100)
  providerMetadata      Json?           @map("provider_metadata")

  // Fulfillment workflow
  approvedForShipment   Boolean         @default(false) @map("approved_for_shipment")
  approvedBy            String?         @map("approved_by") @db.Uuid
  approvedAt            DateTime?       @map("approved_at") @db.Timestamptz
  packedBy              String?         @map("packed_by") @db.Uuid
  packedAt              DateTime?       @map("packed_at") @db.Timestamptz

  // Delivery estimates
  estimatedDeliveryDate DateTime?       @map("estimated_delivery_date") @db.Timestamptz
  actualDeliveryDate    DateTime?       @map("actual_delivery_date") @db.Timestamptz
  signatureRequired     Boolean         @default(false) @map("signature_required")

  // Timestamps
  createdAt             DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime        @updatedAt @map("updated_at") @db.Timestamptz
  shippedAt             DateTime?       @map("shipped_at") @db.Timestamptz

  // Relations
  order                 Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  trackingEvents        ShipmentTracking[]

  @@index([shipmentStatus, createdAt(sort: Desc)])
  @@index([trackingNumber])
  @@index([carrier, shipmentStatus])
  @@map("shipments")
}

model ShipmentTracking {
  id              String      @id @default(uuid()) @db.Uuid
  shipmentId      String      @map("shipment_id") @db.Uuid

  status          String      @db.VarChar(50)
  statusDetail    String?     @map("status_detail") @db.VarChar(255)
  location        String?     @db.VarChar(255)
  eventTime       DateTime    @map("event_time") @db.Timestamptz

  message         String?     @db.Text
  carrierEventId  String?     @map("carrier_event_id") @db.VarChar(100)

  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz

  shipment        Shipment    @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, eventTime(sort: Desc)])
  @@map("shipment_tracking")
}

model ShippingZone {
  id              String      @id @default(uuid()) @db.Uuid
  name            String      @unique @db.VarChar(100)
  description     String?     @db.Text

  statesIncluded  String[]    @map("states_included") // ["CA", "NV", "AZ"]
  zipRanges       Json?       @map("zip_ranges") // [{start: "90000", end: "96999"}]

  priority        Int         @default(0) // Lower = higher priority for matching
  isActive        Boolean     @default(true) @map("is_active")

  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  rates           ShippingRate[]

  @@index([priority, isActive])
  @@map("shipping_zones")
}

model ShippingRate {
  id              String          @id @default(uuid()) @db.Uuid
  zoneId          String          @map("zone_id") @db.Uuid

  shippingMethod  ShippingMethod  @map("shipping_method")
  carrier         ShippingCarrier

  // Weight tiers
  minWeightOz     Int             @map("min_weight_oz")
  maxWeightOz     Int             @map("max_weight_oz")

  // Pricing
  baseRate        Decimal         @map("base_rate") @db.Decimal(10, 2)
  perOzRate       Decimal         @default(0) @map("per_oz_rate") @db.Decimal(10, 4)

  // Delivery time
  minDays         Int             @map("min_days")
  maxDays         Int             @map("max_days")

  // Validity
  effectiveDate   DateTime        @default(now()) @map("effective_date") @db.Timestamptz
  expirationDate  DateTime?       @map("expiration_date") @db.Timestamptz

  isActive        Boolean         @default(true) @map("is_active")

  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  zone            ShippingZone    @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, shippingMethod, isActive])
  @@index([minWeightOz, maxWeightOz])
  @@map("shipping_rates")
}

// ============================================================================
// THIRD-PARTY INTEGRATIONS
// ============================================================================

model DiscogsOAuthToken {
  id                  String   @id @default(uuid()) @db.Uuid

  // OAuth token data
  accessToken         String   @unique @db.VarChar(500) @map("access_token")
  accessTokenSecret   String   @db.VarChar(500) @map("access_token_secret")

  // User identification from Discogs
  discogsUsername     String?  @db.VarChar(255) @map("discogs_username")
  discogsUserId       Int?     @map("discogs_user_id")

  // Token lifecycle
  isActive            Boolean  @default(true) @map("is_active")

  // Timestamps
  obtainedAt          DateTime @default(now()) @map("obtained_at") @db.Timestamptz
  expiresAt           DateTime? @map("expires_at") @db.Timestamptz
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Indexes
  @@index([isActive, createdAt(sort: Desc)])
  @@index([discogsUsername])
  @@map("discogs_oauth_tokens")
}

// ============================================================================
// USER AUTHENTICATION & AUTHORIZATION
// ============================================================================

enum UserRole {
  SUPER_ADMIN  // Full system access, manage users
  ADMIN        // Manage catalog, pricing, inventory
  SELLER       // Submit items, view own submissions
  BUYER        // Browse catalog, place orders
}

// ============================================================================
// ADMIN USERS (for audit tracking)
// ============================================================================

model AdminUser {
  id                    String   @id @default(uuid()) @db.Uuid
  email                 String   @unique @db.VarChar(255)
  name                  String   @db.VarChar(255)
  role                  UserRole @default(BUYER)
  passwordHash          String   @map("password_hash") @db.VarChar(255)
  isActive              Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz
  lastLoginAt           DateTime? @map("last_login_at") @db.Timestamptz

  // Relations
  refreshTokens         RefreshToken[]
  tablePreferences      AdminTablePreference[]

  @@index([email])
  @@index([role, isActive])
  @@map("admin_users")
}

// Refresh tokens for session management and revocation
model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  token       String   @unique @db.VarChar(500)
  userId      String   @map("user_id") @db.Uuid
  expiresAt   DateTime @map("expires_at") @db.Timestamptz
  revokedAt   DateTime? @map("revoked_at") @db.Timestamptz
  replacedBy  String?  @map("replaced_by") @db.Uuid

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user        AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// ADMIN TABLE PREFERENCES (Column Visibility)
// ============================================================================

model AdminTablePreference {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  tableName       String   @map("table_name") @db.VarChar(100)

  // Column visibility stored as JSON object
  // Example: {"title": true, "artist": true, "sku": false}
  visibleColumns  Json     @map("visible_columns")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user            AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Constraints: One preference record per user per table
  @@unique([userId, tableName])
  @@index([userId])
  @@map("admin_table_preferences")
}

// ============================================================================
// INVENTORY RESERVATION & HOLDS
// ============================================================================

enum HoldStatus {
  ACTIVE              // Hold is currently active
  RELEASED            // Hold was released (item available again)
  EXPIRED             // Hold expired without conversion to order
  CONVERTED_TO_SALE   // Hold converted to sold order item
}

model InventoryHold {
  id               String   @id @default(uuid()) @db.Uuid
  inventoryLotId   String   @map("inventory_lot_id") @db.Uuid

  // Order/Cart tracking
  orderId          String?  @map("order_id") @db.Uuid
  sessionId        String?  @map("session_id") @db.VarChar(255)  // For guest carts

  // Hold status and lifecycle
  holdStatus       HoldStatus @default(ACTIVE) @map("hold_status")
  quantity         Int        @default(1)  // Support for multi-unit holds if needed

  // Hold validity
  expiresAt        DateTime   @map("expires_at") @db.Timestamptz
  releasedAt       DateTime?  @map("released_at") @db.Timestamptz
  releasedReason   String?    @map("released_reason") @db.VarChar(255)

  // Audit trail
  createdBy        String?    @map("created_by") @db.Uuid
  createdAt        DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  inventoryLot     InventoryLot @relation(fields: [inventoryLotId], references: [id], onDelete: Cascade)
  order            Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Indexes for efficient queries
  @@index([inventoryLotId, holdStatus])
  @@index([orderId, holdStatus])
  @@index([sessionId, holdStatus])
  @@index([expiresAt, holdStatus])  // For finding expired holds
  @@index([holdStatus, createdAt(sort: Desc)])
  @@map("inventory_holds")
}

model InventoryHoldAudit {
  id               String   @id @default(uuid()) @db.Uuid
  holdId           String   @map("hold_id") @db.Uuid

  // Status transition tracking
  fromStatus       HoldStatus @map("from_status")
  toStatus         HoldStatus @map("to_status")
  reason           String?    @db.VarChar(255)

  // Metadata
  changedBy        String?    @map("changed_by") @db.Uuid
  changedAt        DateTime   @default(now()) @map("changed_at") @db.Timestamptz

  // Indexes
  @@index([holdId, changedAt(sort: Desc)])
  @@index([changedAt(sort: Desc)])
  @@map("inventory_hold_audits")
}
